version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

steps:
  - type: Command
    name: "Build with updated Dockerfiles using Oracle Container Registry"
    timeoutInSeconds: 3600
    command: |
      echo "=== DASHMASTER BUILD CON DOCKERFILES ACTUALIZADOS ==="
      echo "Timestamp: $(date)"
      echo "Build Run ID: ${OCI_BUILD_RUN_ID}"
      
      BACKEND_FULL_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}"
      FRONTEND_FULL_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}"
      
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # Autenticaci√≥n con Oracle Container Registry
      echo "=== üîê AUTENTICACI√ìN CON ORACLE CONTAINER REGISTRY ==="
      if echo "JzE_4#PtkzhjJ0h#c6T" | docker login container-registry.oracle.com --username "a01254805@tec.mx" --password-stdin; then
        echo "‚úÖ Oracle Container Registry autenticado"
      else
        echo "‚ùå Error en autenticaci√≥n"
        exit 1
      fi
      
      # Construir backend usando Dockerfile actualizado
      echo "=== üî® CONSTRUYENDO BACKEND ==="
      cd MtdrSpring/backend
      docker build -t ${BACKEND_FULL_TAG} .
      
      if [ $? -eq 0 ]; then
        echo "‚úÖ Backend construido exitosamente"
      else
        echo "‚ùå Error construyendo backend"
        exit 1
      fi
      
      # Construir frontend usando Dockerfile actualizado
      echo "=== üî® CONSTRUYENDO FRONTEND ==="
      cd ${OCI_PRIMARY_SOURCE_DIR}/MtdrSpring/frontend
      docker build -t ${FRONTEND_FULL_TAG} .
      
      if [ $? -eq 0 ]; then
        echo "‚úÖ Frontend construido exitosamente"
      else
        echo "‚ùå Error construyendo frontend"
        exit 1
      fi
      
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # Autenticaci√≥n con OCIR y push de im√°genes
      echo "=== üîê AUTENTICACI√ìN CON OCIR ==="
      if echo "{vh]]d:0R#E#pwI4Hnkp" | docker login mx-queretaro-1.ocir.io --username "ax6xpbwtbt9g/a01254673@tec.mx" --password-stdin; then
        echo "‚úÖ OCIR autenticado"
      else
        echo "‚ùå Error con OCIR"
        exit 1
      fi
      
      # Push de im√°genes
      echo "=== üì§ SUBIENDO IM√ÅGENES ==="
      docker push ${BACKEND_FULL_TAG} && docker tag ${BACKEND_FULL_TAG} "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:latest" && docker push "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:latest"
      docker push ${FRONTEND_FULL_TAG} && docker tag ${FRONTEND_FULL_TAG} "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:latest" && docker push "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:latest"
      
      if [ -f "deployment.yaml" ]; then
        cp deployment.yaml ${OCI_WORKSPACE_DIR}/deployment.yaml
      fi
      
      echo "=== üéâ BUILD COMPLETADO ==="

outputArtifacts:
  - name: backend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}
  - name: frontend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}
  - name: deployment_artifacts
    type: BINARY
    location: deployment.yaml