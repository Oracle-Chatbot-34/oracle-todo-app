version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

steps:
  # Paso único que hace todo el proceso con autenticación mejorada
  - type: Command
    name: "Complete build and push process with authentication"
    timeoutInSeconds: 3600
    command: |
      echo "=== PROCESO COMPLETO DE BUILD CON AUTENTICACIÓN ==="
      echo "Timestamp: $(date)"
      echo "Build Run ID: ${OCI_BUILD_RUN_ID}"
      
      # Construir tags usando la variable de build ID
      BACKEND_FULL_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}"
      FRONTEND_FULL_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}"
      
      echo "Backend tag: ${BACKEND_FULL_TAG}"
      echo "Frontend tag: ${FRONTEND_FULL_TAG}"
      
      # Navegar al directorio de código fuente
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # PASO CRÍTICO: Autenticación con Oracle Container Registry para imágenes base
      echo "=== AUTENTICACIÓN CON ORACLE CONTAINER REGISTRY ==="
      echo "Autenticando para acceder a imágenes base (maven, node, nginx)..."
      
      # Login para Oracle Container Registry (para pull de imágenes base)
      if echo "{vh]]d:0R#E#pwI4Hnkp" | docker login container-registry.oracle.com --username "a01254673/a01254673@tec.mx" --password-stdin; then
        echo "✅ Login exitoso con Oracle Container Registry"
      else
        echo "❌ Error en login con Oracle Container Registry"
        echo "Intentando formato de username alternativo..."
        if echo "{vh]]d:0R#E#pwI4Hnkp" | docker login container-registry.oracle.com --username "a01254673@tec.mx" --password-stdin; then
          echo "✅ Login exitoso con formato alternativo"
        else
          echo "❌ Ambos formatos de login fallaron para Oracle Container Registry"
          exit 1
        fi
      fi
      
      # CONSTRUIR BACKEND
      echo "=== CONSTRUYENDO BACKEND ==="
      cd MtdrSpring/backend
      
      # El Dockerfile ahora puede hacer pull de la imagen maven desde Oracle Container Registry
      docker build -t ${BACKEND_FULL_TAG} .
      
      if [ $? -eq 0 ]; then
        echo "✅ Backend construido exitosamente"
      else
        echo "❌ Error construyendo el backend"
        exit 1
      fi
      
      # Regresar al directorio raíz
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # CONSTRUIR FRONTEND
      echo "=== CONSTRUYENDO FRONTEND ==="
      cd MtdrSpring/frontend
      
      # El Dockerfile ahora puede hacer pull de la imagen node desde Oracle Container Registry
      docker build -t ${FRONTEND_FULL_TAG} .
      
      if [ $? -eq 0 ]; then
        echo "✅ Frontend construido exitosamente"
      else
        echo "❌ Error construyendo el frontend"
        exit 1
      fi
      
      # Regresar al directorio raíz
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # MOSTRAR IMÁGENES CONSTRUIDAS
      echo "=== IMÁGENES CONSTRUIDAS ==="
      docker images | grep "mx-queretaro-1.ocir.io/ax6xpbwtbt9g"
      
      # AUTENTICACIÓN CON OCIR PARA PUSH DE IMÁGENES
      echo "=== AUTENTICACIÓN CON OCIR PARA PUSH ==="
      echo "Registry: mx-queretaro-1.ocir.io"
      echo "Namespace: ax6xpbwtbt9g"
      
      # Login para OCIR (para push de nuestras imágenes construidas)
      echo "Autenticando con OCIR para push de imágenes..."
      if echo "{vh]]d:0R#E#pwI4Hnkp" | docker login mx-queretaro-1.ocir.io --username "ax6xpbwtbt9g/a01254673@tec.mx" --password-stdin; then
        echo "✅ Login exitoso con OCIR"
      else
        echo "❌ Error en login con OCIR. Intentando formato alternativo..."
        if echo "{vh]]d:0R#E#pwI4Hnkp" | docker login mx-queretaro-1.ocir.io --username "ax6xpbwtbt9g/a01254673" --password-stdin; then
          echo "✅ Login exitoso con OCIR formato alternativo"
        else
          echo "❌ Ambos formatos de login fallaron con OCIR"
          exit 1
        fi
      fi
      
      # PUSH BACKEND IMAGE
      echo "=== PUSHING BACKEND IMAGE ==="
      docker push ${BACKEND_FULL_TAG}
      
      if [ $? -eq 0 ]; then
        echo "✅ Backend image subida exitosamente: ${BACKEND_FULL_TAG}"
        
        # Crear tag 'latest' para facilitar deployment
        BACKEND_LATEST_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:latest"
        docker tag ${BACKEND_FULL_TAG} ${BACKEND_LATEST_TAG}
        docker push ${BACKEND_LATEST_TAG}
        echo "✅ Backend image también subida como: ${BACKEND_LATEST_TAG}"
      else
        echo "❌ Error subiendo backend image"
        exit 1
      fi
      
      # PUSH FRONTEND IMAGE
      echo "=== PUSHING FRONTEND IMAGE ==="
      docker push ${FRONTEND_FULL_TAG}
      
      if [ $? -eq 0 ]; then
        echo "✅ Frontend image subida exitosamente: ${FRONTEND_FULL_TAG}"
        
        # Crear tag 'latest' para facilitar deployment
        FRONTEND_LATEST_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:latest"
        docker tag ${FRONTEND_FULL_TAG} ${FRONTEND_LATEST_TAG}
        docker push ${FRONTEND_LATEST_TAG}
        echo "✅ Frontend image también subida como: ${FRONTEND_LATEST_TAG}"
      else
        echo "❌ Error subiendo frontend image"
        exit 1
      fi
      
      # PREPARAR DEPLOYMENT MANIFEST
      echo "=== PREPARANDO DEPLOYMENT MANIFEST ==="
      if [ ! -f "deployment.yaml" ]; then
        echo "ERROR: deployment.yaml no encontrado"
        exit 1
      fi
      
      cp deployment.yaml ${OCI_WORKSPACE_DIR}/deployment.yaml
      echo "✅ Deployment manifest preparado"
      
      echo "=== PROCESO COMPLETADO EXITOSAMENTE ==="
      echo "Backend: ${BACKEND_FULL_TAG}"
      echo "Frontend: ${FRONTEND_FULL_TAG}"
      echo "Ambas imágenes también disponibles con tag 'latest'"

outputArtifacts:
  - name: backend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}
  - name: frontend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}
  - name: deployment_artifacts
    type: BINARY
    location: deployment.yaml