version: 0.1
component: build
timeoutInSeconds: 3000
runAs: root
shell: bash

steps:
  - type: Command
    name: "Simple and fast build"
    timeoutInSeconds: 1800
    command: |
      echo "=== BUILD RÁPIDO Y SIMPLE ==="
      
      BACKEND_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}"
      FRONTEND_TAG="mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}"
      
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # Build backend - sin autenticación especial, usa Docker Hub
      echo "=== BACKEND BUILD ==="
      cd MtdrSpring/backend
      docker build -t ${BACKEND_TAG} .
      if [ $? -ne 0 ]; then echo "Backend build failed"; exit 1; fi
      
      # Build frontend - sin validación nginx en build time
      echo "=== FRONTEND BUILD ==="
      cd ${OCI_PRIMARY_SOURCE_DIR}/MtdrSpring/frontend
      docker build -t ${FRONTEND_TAG} .
      if [ $? -ne 0 ]; then echo "Frontend build failed"; exit 1; fi
      
      cd ${OCI_PRIMARY_SOURCE_DIR}
      
      # Login a OCIR y push
      echo "=== PUSH TO OCIR ==="
      echo "{vh]]d:0R#E#pwI4Hnkp" | docker login mx-queretaro-1.ocir.io --username "ax6xpbwtbt9g/a01254673@tec.mx" --password-stdin
      
      docker push ${BACKEND_TAG}
      docker tag ${BACKEND_TAG} "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:latest"
      docker push "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:latest"
      
      docker push ${FRONTEND_TAG}
      docker tag ${FRONTEND_TAG} "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:latest"  
      docker push "mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:latest"
      
      echo "=== BUILD COMPLETED ==="

outputArtifacts:
  - name: backend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-backend:${OCI_BUILD_RUN_ID}
  - name: frontend_image
    type: DOCKER_IMAGE
    location: mx-queretaro-1.ocir.io/ax6xpbwtbt9g/dashmaster-frontend:${OCI_BUILD_RUN_ID}